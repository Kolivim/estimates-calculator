<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                                       http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.0.xsd">


    <changeSet id="activateUuidOsspExtension" author="Kolivim">
        <sql>CREATE
        EXTENSION IF NOT EXISTS "uuid-ossp";</sql>
    </changeSet>

    <changeSet id="createRoleTable" author="kolivim">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="role"/>
            </not>
        </preConditions>
        <createTable tableName="role">
            <column name="is_deleted" type="boolean"/>
            <column name="id" type="uuid">
                <constraints primaryKey="true"/>
            </column>
            <column name="role" type="varchar(255)"/>
        </createTable>
    </changeSet>

    <changeSet id="populateRolesTable" author="kolivim">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">SELECT COUNT(*)
                                         FROM role</sqlCheck>
        </preConditions>

        <sql>
            INSERT INTO role (id, role)
            VALUES (uuid_generate_v4(), 'VIEWER');
            INSERT INTO role (id, role)
            VALUES (uuid_generate_v4(), 'ESTIMATOR');
            INSERT INTO role (id, role)
            VALUES (uuid_generate_v4(), 'ADMIN');
        </sql>
    </changeSet>

    <changeSet id="createUsersTable" author="kolivim">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="users"/>
            </not>
        </preConditions>
        <createTable tableName="users">
            <column name="is_deleted" type="boolean"/>
            <column name="id" type="uuid">
                <constraints primaryKey="true"/>
            </column>
            <column name="first_name" type="varchar(255)"/>
            <column name="middle_name" type="varchar(255)"/>
            <column name="last_name" type="varchar(255)"/>
            <column name="password" type="varchar(255)"/>
<!--            <column name="created_by" type="jsonb"/>-->
<!--            <column name="created_date" type="timestamp(6)"/>-->
<!--            <column name="last_modified_by" type="jsonb"/>-->
        </createTable>
    </changeSet>

    <changeSet id="createAccountTable" author="kolivim">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="account"/>
            </not>
        </preConditions>
        <createTable tableName="account">
            <column name="is_blocked" type="boolean"/>
            <column name="last_online_time" type="timestamp(6) with time zone"/>
            <column name="id" type="uuid">
                <constraints primaryKey="true"/>
            </column>
            <column name="about" type="varchar(255)"/>
            <column name="phone" type="varchar(255)"/>
            <column name="email" type="varchar(255)"/>
            <column name="position" type="varchar(255)"/>
            <column name="department" type="varchar(255)"/>
            <column name="personnel_number" type="varchar(255)"/>
            <column name="registration_date" type="timestamp(6) with time zone"/>
            <column name="last_modified_date" type="timestamp(6) with time zone"/>
<!--            <column name="photo" type="varchar(255)"/>-->
<!--            <column name="is_online" type="boolean"/>-->
        </createTable>
    </changeSet>

    <changeSet id="createOrganizationTable" author="kolivim">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="organization"/>
            </not>
        </preConditions>
        <createTable tableName="organization">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="is_deleted" type="boolean"/>
            <column name="name" type="varchar(255)"/>
            <column name="phone" type="varchar(255)"/>
            <column name="email" type="varchar(255)"/>
            <column name="description" type="MEDIUMTEXT"/>
            <column name="last_author_id" type="uuid"/>
            <column name="registration_date" type="timestamp(6) with time zone"/>
            <column name="last_modified_date" type="timestamp(6) with time zone"/>
        </createTable>
    </changeSet>

    <changeSet id="createPositionTable" author="kolivim">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="position"/>
            </not>
        </preConditions>
        <createTable tableName="position">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="is_deleted" type="boolean"/>
            <column name="name" type="varchar(255)"/>
            <column name="department_id" type="uuid"/>
            <column name="description" type="MEDIUMTEXT"/>
            <column name="last_author_id" type="uuid"/>
            <column name="registration_date" type="timestamp(6) with time zone"/>
            <column name="last_modified_date" type="timestamp(6) with time zone"/>
        </createTable>
    </changeSet>

    <changeSet id="createDepartmentTable" author="kolivim">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="department"/>
            </not>
        </preConditions>
        <createTable tableName="department">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="is_deleted" type="boolean"/>
            <column name="organization_id" type="uuid"/>
            <column name="name" type="varchar(255)"/>
            <column name="description" type="MEDIUMTEXT"/>
            <column name="last_author_id" type="uuid"/>
            <column name="registration_date" type="timestamp(6) with time zone"/>
            <column name="last_modified_date" type="timestamp(6) with time zone"/>
        </createTable>
    </changeSet>

    <changeSet id="createUserRoleTable" author="kolivim">
        <createTable tableName="user_role">
            <column name="role_id" type="uuid">
                <constraints primaryKey="true"/>
            </column>
            <column name="user_id" type="uuid">
                <constraints primaryKey="true"/>
            </column>
            <column name="estimate_id" type="uuid">
            </column>
        </createTable>
    </changeSet>

<!--    <changeSet id="createTokenTable" author="kolivim">-->
<!--        <createTable tableName="recover_token">-->
<!--            <column name="id" type="uuid">-->
<!--                <constraints primaryKey="true"/>-->
<!--            </column>-->
<!--            <column name="is_deleted" type="boolean"/>-->
<!--            <column name="account_id" type="uuid"/>-->
<!--            <column name="expiration_time" type="TIMESTAMP"/>-->
<!--        </createTable>-->
<!--    </changeSet>-->

<!--    <changeSet id="createCaptchaTable" author="anton">-->
<!--        <createTable tableName="captcha">-->
<!--            <column name="id" type="uuid">-->
<!--                <constraints primaryKey="true"/>-->
<!--            </column>-->
<!--            <column name="is_deleted" type="boolean"/>-->
<!--            <column name="answer" type="varchar(255)"/>-->
<!--            <column name="expiration_time" type="TIMESTAMP"/>-->
<!--        </createTable>-->
<!--    </changeSet>-->

<!--    <include file="account\initial_account_user.xml" relativeToChangelogFile="true"/>-->
</databaseChangeLog>

